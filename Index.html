<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游꾸 Revolution Wax - 춰Acomular y Gana!</title>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --color-principal: #007bff;
            /* Azul para Login */
            --color-lealtad: #4CAF50;
            /* Verde para Lealtad */
            --color-secundario: #FF9800;
            --color-fondo: #f4f4f4;
            --color-texto: #333;
            --color-negro: #212529; /* Negro para la barra de navegaci칩n */
        }

        /* ===================================================================
        === BARRA DE LOGIN NE칍N
        ===================================================================
        */
        #login-nav-bar {
            background-color: var(--color-negro);
            color: white;
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
        }

        .neon-text {
            color: #FFFF00; /* Amarillo Ne칩n */
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 0 0 5px #FFFF00, 0 0 10px #FFFF00;
            animation: blinker 1s cubic-bezier(.5, 0, 1, 1) infinite alternate;
        }

        @keyframes blinker {
            from {
                opacity: 1;
            }
            to {
                opacity: 0.7;
            }
        }
        /*
        ===================================================================
        === FIN DE ESTILOS DE BARRA DE LOGIN NE칍N
        ===================================================================
        */

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            margin: 0;
            padding: 0;
            text-align: center;
        }
        /* --- BARRA DE NAVEGACI칍N SUPERIOR (OCULTA POR DEFECTO EN EL HTML, MOSTRADA POR JS EN SESI칍N) --- */
        #nav-bar {
            display: none; /* Oculto por defecto */
            background-color: var(--color-negro);
            color: white;
            padding: 10px 25px; /* Barra m치s grande */
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        #nav-bar .nav-logo img {
            height: 40px; /* Logo m치s grande y visible */
            width: auto;
        }
        #nav-bar .nav-links {
            display: flex;
            align-items: center;
        }
        #nav-bar .nav-links a,
        #nav-bar .nav-links .dropdown-btn {
            color: white;
            text-decoration: none;
            margin-left: 25px;
            padding: 10px 0;
            font-weight: 600;
            font-size: 1.1em; /* Texto m치s grande */
            cursor: pointer;
            background: none;
            border: none;
            position: relative;
            transition: color 0.2s;
        }
        #nav-bar .nav-links a:hover,
        #nav-bar .nav-links .dropdown-btn:hover {
            color: var(--color-lealtad);
        }
        /* Dropdown Menu Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--color-negro);
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 10;
            top: 100%; /* Posicionar debajo del bot칩n */
            left: -50px;
        }
        .dropdown-content a {
            color: white !important;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            margin-left: 0;
            font-size: 0.9em;
        }
        .dropdown-content a:hover {
            background-color: #3e3e3e;
            color: var(--color-secundario) !important;
        }
        /* La clase 'show' se usa en JS para mostrar el men칰 */
        .dropdown-content.show {
            display: block;
        }
        
        /* ESTILOS DEL BOT칍N "IR ARRIBA" */
        #scrollToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--color-lealtad);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: opacity 0.3s;
        }
        #scrollToTopBtn:hover {
            background-color: #388e3c;
        }
        /* --- Contenedor y Logo en Login --- */
        .logo-container {
            padding-bottom: 20px;
            text-align: center;
        }
        .logo-container img {
            max-width: 150px;
            height: auto;
        }
        .contenedor {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        h1 {
            color: var(--color-principal);
            border-bottom: 3px solid var(--color-lealtad);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        /* --- Login Section Styling --- */
        #login-section {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            text-align: left;
            max-width: 400px;
            margin: 0 auto;
        }
        #login-section .logo-container {
             padding-top: 0; 
             padding-bottom: 15px; 
             margin-top: -15px;
        }

        #login-section input {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn-login {
            background-color: var(--color-secundario);
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1.1em;
        }
        .btn-link {
            background: none;
            border: none;
            color: var(--color-principal);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9em;
            padding: 5px 0;
            display: block;
            width: 100%;
            text-align: center;
        }
        #login-section .btn-create {
            background-color: var(--color-lealtad);
            color: white;
            width: 100%;
            margin-top: 10px;
            margin-bottom: 5px;
            padding: 10px 20px;
            border-radius: 4px;
        }
        
        /* === ESTILOS PARA DESCARGA APK === */
        #apk-download-container {
            text-align: center;
            padding: 15px 0;
            border-top: 1px dashed #ccc;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        #apk-download-container img {
            width: 40px; 
            height: auto;
            vertical-align: middle;
            margin-right: 10px;
        }

        .btn-download-apk {
            background-color: var(--color-lealtad); 
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .btn-download-apk:hover {
            background-color: #388e3c; /* Verde m치s oscuro */
        }
        /* ======================================= */

        /* --- Lealtad Section Styling (Hidden by default) --- */
        #lealtad-section {
            display: none;
        }
        #puntos-actuales {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--color-lealtad);
            margin: 10px 0 20px 0;
            padding: 10px;
            border: 2px dashed var(--color-lealtad);
            display: inline-block;
            border-radius: 5px;
        }
        /* Estilos para el listado por categor칤a */
        .categoria-titulo {
            /* Se a침ade un ID para poder navegar a este t칤tulo */
            color: var(--color-principal);
            background-color: #f0f0f0; 
            padding: 10px;
            margin: 30px 0 15px 0;
            border-radius: 5px;
            font-size: 1.5em;
            text-align: left;
            font-weight: bold;
        }
        
        /* === MODIFICACI칍N PARA CARRUSEL === */
        .catalogo-categoria {
            display: flex;
            overflow-x: scroll;
            padding: 10px;
            gap: 20px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .catalogo-categoria::-webkit-scrollbar {
            display: none;
        }
        
        .premio {
            flex-shrink: 0;
            width: 250px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: left;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 350px; 
            box-sizing: border-box;
        }
        /* ================================= */

        .premio img {
            max-width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .premio .puntos-costo {
            font-weight: bold;
            color: var(--color-secundario);
            font-size: 1.2em;
            display: block;
            margin: 10px 0;
        }
        .btn-canjear {
            background-color: var(--color-secundario);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: auto;
            transition: background-color 0.3s;
        }
        .btn-canjear:disabled {
            background-color: var(--color-principal) !important;
            color: white; 
            cursor: not-allowed;
            font-weight: bold;
        }
        .social-links {
            padding-top: 50px;
            margin: 20px 0;
            padding-bottom: 10px;
        }
        
        /* === ESTILOS MODIFICADOS PARA ICONOS DE REDES SOCIALES === */
        .social-links a {
            font-size: 2.5em; /* Iconos m치s grandes */
            margin: 0 15px;
            transition: transform 0.3s, color 0.3s;
        }
        .social-links a:hover {
            transform: scale(1.1); /* Efecto de acercamiento al pasar el rat칩n */
        }

        /* Colores espec칤ficos para cada red social */
        .fa-facebook-square {
            color: #3b5998; /* Azul de Facebook */
        }

        .fa-instagram {
            /* Degradado de Instagram */
            background: -webkit-linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .fa-whatsapp {
            color: #25d366; /* Verde de WhatsApp */
        }
        /* ======================================================== */
        
        /* --- MODALES --- */
        .modal {
            display: none;
            position: fixed; 
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        
        /* Estilos para el modal de Bienvenida */
        #welcome-modal .modal-content {
            border: 5px solid var(--color-lealtad);
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        #welcome-modal .modal-content h2 {
            color: var(--color-lealtad);
            border-bottom: 2px solid var(--color-secundario);
            padding-bottom: 10px;
        }
        .btn-facebook-link {
            background-color: #3b5998; /* Azul de Facebook */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 90%;
            max-width: 300px;
            margin-top: 15px;
            text-decoration: none; /* Asegura que no tenga subrayado */
            display: inline-block;
        }

        /* Estilo para el modal de advertencia */
        #security-warning-modal {
            background-color: transparent;
            z-index: 150; 
            padding-top: 10%; 
        }

        #security-warning-modal .modal-content {
            background-color: white;
            color: var(--color-principal);
            border: 3px solid var(--color-secundario);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        #security-warning-modal .modal-content h2 {
            color: #d32f2f; /* Rojo para la advertencia */
        }
        
        #security-warning-modal .modal-content button {
            background-color: var(--color-secundario);
            margin-top: 20px;
        }


        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 30px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 400px;
            border-radius: 10px;
            text-align: center;
        }
        .modal-content input[type=text], .modal-content input[type=password] {
            padding: 10px;
            margin: 10px 0;
            width: 90%;
            border: 2px solid var(--color-lealtad);
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
            box-sizing: border-box;
        }
        .modal-content button {
            background-color: var(--color-lealtad);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 90%;
            max-width: 300px;
        }
        .close-btn {
            float:right;
            cursor:pointer; 
            font-size: 24px;
        }
        footer {
            margin-top: 30px;
            padding: 15px;
            background-color: #333;
            color: white;
            font-size: 0.9em;
        }
        footer a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }
        footer a:hover {
            text-decoration: underline;
        }
        
        /* === ESTILO PARA BOT칍N CERRAR SESI칍N ROJO === */
        .btn-logout {
            background-color: #dc3545; /* Rojo de Bootstrap */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 30px; /* Para separarlo de los premios */
            transition: background-color 0.3s;
            width: 100%; /* Ocupa todo el ancho disponible */
            box-sizing: border-box;
        }
        .btn-logout:hover {
            background-color: #c82333; /* Rojo m치s oscuro al pasar el rat칩n */
        }

        /* === ESTILOS PARA LA TARJETA DE ESTAD칈STICAS Y BOTONES (NUEVOS) === */
        #stats-card {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid #ccc;
        }
        .stats-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .stat-button {
            flex: 1;
            padding: 15px 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        .stat-button:hover {
            opacity: 0.9;
        }
        .stat-button .stat-value {
            font-size: 1.8em;
            display: block;
            margin-bottom: 5px;
        }
        #btn-scans {
            background-color: var(--color-lealtad); /* Verde */
        }
        #btn-redeems {
            background-color: var(--color-secundario); /* Naranja */
        }
        /* Estilo para el bot칩n Acomular */
        #btn-acumular {
            background-color: var(--color-principal); /* Azul */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 15px;
            transition: background-color 0.3s;
            width: 90%;
            max-width: 300px;
        }
        #btn-acumular:hover {
            background-color: #0056b3; /* Azul m치s oscuro */
        }

        /* Estilo espec칤fico para el modal de historial */
        .history-modal-content {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .history-modal-content h2 {
            color: var(--color-principal);
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }
        .history-list-popup {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        .history-list-popup li {
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 0.95em;
        }
        .history-list-popup li:last-child {
            border-bottom: none;
        }
        .scan-item {
            color: var(--color-lealtad); /* Verde */
        }
        .redeem-item {
            color: var(--color-secundario); /* Naranja */
        }
        /* ======================================================== */
    </style>
</head>
<body onscroll="scrollFunction()">

    <div id="login-nav-bar">
        <span class="neon-text">Revolution Wax Formula Premium</span>
    </div>
    
    <div id="nav-bar" style="display: none;">
        <div class="nav-logo">
            <img src="https://i.postimg.cc/3W5Sj9KD/1759816774563.png" alt="Logo">
        </div>
        <div class="nav-links">
            <a href="#" onclick="topFunction(); return false;">Inicio</a>
            
            <div class="dropdown">
                <button class="dropdown-btn" onclick="toggleDropdown(this)">Premios <i class="fas fa-caret-down"></i></button>
                <div class="dropdown-content" id="premios-dropdown">
                    </div>
            </div>

            <a href="#" onclick="scrollToContact(); return false;">Contacto</a>
        </div>
    </div>
    
    <div class="contenedor">
        
        <h1 id="main-title">游끠 Revolution Wax 游끠</h1>

        <div id="login-section">
            
            <div class="logo-container">
                <img src="https://i.postimg.cc/3W5Sj9KD/1759816774563.png" alt="Logotipo de la Empresa">
            </div>

            <h2>Iniciar Sesi칩n</h2>
            
            <form id="login-form">
                <label for="username"><b>Usuario</b></label>
                <input type="text" placeholder="Ingresa Usuario" name="username" id="username" required>

                <label for="psw"><b>Contrase침a</b></label>
                <input type="password" placeholder="Ingresa Contrase침a" name="psw" id="psw" required>
                    
                <button type="submit" class="btn-login">Iniciar Sesi칩n</button>
             
                <p id="login-error" style="color:red; text-align:center;"></p>
            </form>

            <button class="btn-create" onclick="document.getElementById('security-warning-modal').style.display='block'">Crear Usuario</button>
            <button class="btn-link" onclick="document.getElementById('forgot-password-modal').style.display='block'">쯆lvidaste contrase침a?</button>

            <div id="apk-download-container">
                <p style="font-weight: bold; margin-bottom: 10px;">
                    <img src="https://i.postimg.cc/vZyRpJjq/unnamed.png" alt="Logo Android"> 
                    춰Descarga nuestra App Oficial! (Solo Android)
                </p>
                <a href="https://drive.google.com/uc?export=download&id=1EsA2B3oP0ieX-YIYAf3SZJ26hxDM5QeT" download class="btn-download-apk" title="Descargar APK de la aplicaci칩n">
                    Descargar APK
                </a>
                
            </div>
            </div>

        <div id="lealtad-section">
            <p>Bienvenido, <strong id="user-display"></strong></p>
            
            <div style="background-color: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h2>Mi Saldo de Puntos</h2>
                <span id="puntos-actuales">0 Puntos</span>
                
                <h2>Escanea para Sumar Puntos</h2>
                <p style="font-weight: bold;
                color: #d32f2f;">
                    游녤 INSTRUCCIONES: Escanea este QR solo para "Navegador y Iphone" o haz clic en el bot칩n "Acomular" si tienes la aplicaci칩n instalada en Android.
                </p>
                
                <div id="qr-code"></div>

                <button id="btn-acumular" onclick="openAcumularModal()">
                    Acomular (Aplicaci칩n)
                </button>
                
                <p id="qr-info" style="font-size: 0.8em; color: #777; display: none;"></p>
            </div>
            
            <h2 id="premios-section-title">游꾸 Cat치logo de Premios</h2>
            <div id="catalogo-premios"></div>
            
            <button class="btn-logout" onclick="logout()">Cerrar Sesi칩n</button>
            
            <div id="stats-card">
                <p style="font-weight: bold; margin-bottom: 15px; color: var(--color-negro);">Historial y Estad칤sticas R치pidas:</p>
                <div class="stats-buttons">
                    <button id="btn-scans" class="stat-button" onclick="openHistoryModal('scan')">
                        <span class="stat-value" id="total-scans">0</span>
                        <span>Escaneos Realizados</span>
                    </button>
                    <button id="btn-redeems" class="stat-button" onclick="openHistoryModal('redeem')">
                        <span class="stat-value" id="total-redeems">0</span>
                        <span>Regalos Canjeados</span>
                    </button>
                </div>
            </div>
            </div>
    
    </div>

    <div class="social-links" id="contacto-redes">
        <p style="font-weight: bold;">S칤guenos y cont치ctanos:</p>
        <a href="https://www.facebook.com/AngelDZamoraNS" target="_blank" title="Visita nuestro Facebook">
            <i class="fab fa-facebook-square"></i>
        </a>
        <a href="https://www.instagram.com/angelzamorange" target="_blank" title="S칤guenos en Instagram">
            <i class="fab fa-instagram"></i>
        </a>
        <a href="https://wa.me/5217719624236" target="_blank" title="Escr칤benos por WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>
    
    <div id="history-modal" class="modal">
        <div class="modal-content history-modal-content">
            <span class="close-btn" onclick="document.getElementById('history-modal').style.display='none'">&times;</span>
            <h2 id="history-modal-title">Historial de Movimientos</h2>
            <ul id="history-list-popup" class="history-list-popup">
                <li>Cargando historial...</li>
            </ul>
            <button style="background-color: var(--color-principal);" onclick="document.getElementById('history-modal').style.display='none'">Cerrar</button>
        </div>
    </div>
    <div id="welcome-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('welcome-modal').style.display='none'">&times;</span>
            <h2>춰Bienvenido al Programa de Lealtad!</h2>
            <p style="font-size: 1.1em; margin-bottom: 20px;">
                Esta es tu aplicaci칩n de lealtad. Con ella, todas tus compras acumular치n puntos que podr치s canjear por incre칤bles premios exclusivos 游꾸.
            </p>
            
            <a href="https://www.facebook.com/AngelDZamoraNS" target="_blank" class="btn-facebook-link">
                <i class="fab fa-facebook-f"></i> S칤guenos en Facebook
            </a>
        </div>
    </div>

    <div id="security-warning-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('security-warning-modal').style.display='none'">&times;</span>
            <h2>丘멆잺 춰ALERTA DE SEGURIDAD! 丘멆잺</h2>
            <p style="font-size: 1.1em; font-weight: bold; color: var(--color-negro);">
                Para proteger tus puntos de lealtad, NUNCA compartas tu usuario, contrase침a o correo electr칩nico con nadie.
                <br><br>
                Nosotros nunca te los solicitaremos por canales no oficiales.
            </p>
            <button onclick="document.getElementById('security-warning-modal').style.display='none'; document.getElementById('create-user-modal').style.display='block'">Entendido, continuar a Registro</button>
            <button style="background-color: #6c757d;" onclick="document.getElementById('security-warning-modal').style.display='none'">Cancelar</button>
        </div>
    </div>
    
    <div id="redemption-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('redemption-modal').style.display='none'">&times;</span>
            <h2>춰Escaneo Detectado!</h2>
            <p>Para sumar puntos a tu cuenta, ingresa el c칩digo de canje proporcionado:</p>
            <input type="text" id="redemption-code" placeholder="C칩digo de Puntos" maxlength="9">
            <button onclick="procesarCanjeQR()">Confirmar C칩digo</button>
            <p id="modal-message" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="acumular-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('acumular-modal').style.display='none'">&times;</span>
            <h2>Acomular Puntos (C칩digo)</h2>
            <p>Ingresa tu c칩digo de canje o c칩digo secreto para sumar puntos: el c칩digo de canje lo colocara el promotor de servicios</p>
            <input type="text" id="secret-code" placeholder="C칩digo Secreto/Canje" maxlength="9">
            <button onclick="procesarCodigoSecreto()">Acomular Puntos</button>
            <p id="acumular-modal-message" style="color:red; margin-top:10px;"></p>
        </div>
    </div>


    <div id="create-user-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('create-user-modal').style.display='none'">&times;</span>
            <h2>Crear Nueva Cuenta / Contacto</h2>
            <p>Env칤a un mensaje a WhatsApp para solicitar tu registro o contactar al administrador:</p>
            <form id="create-user-form">
                <input type="text" placeholder="Correo Electr칩nico" id="new-email" required>
                <input type="text" placeholder="Usuario" id="new-username" required>
                <input type="password" placeholder="Contrase침a" id="new-psw" required>
                <button type="button" onclick="crearUsuarioWhatsapp()">Enviar Solicitud / Contactar</button>
            </form>
            <p id="create-message" style="color:green; margin-top:10px;"></p>
        </div>
    </div>

    <div id="forgot-password-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('forgot-password-modal').style.display='none'">&times;</span>
            <h2>Recuperar Contrase침a</h2>
            <input type="text" placeholder="Correo Electr칩nico" id="recover-email" required>
            <input type="text" placeholder="Usuario" id="recover-username" required>
            <button onclick="recuperarContrasena()">Mostrar Contrase침a</button>
            <p id="recover-message" style="margin-top:10px;"></p>
        </div>
    </div>

    <footer>
        &copy; 2025 Revolution Wax Premios. Todos los derechos reservados.<br>
        Creador de la p치gina: <a href="mailto: mrandroidtutorialeshd@gmail.com">Juan Zamora</a>
    </footer>
    
    <button onclick="topFunction()" id="scrollToTopBtn" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
        // --- CONFIGURACI칍N GENERAL ---
        const CLAVE_ALMACENAMIENTO_USUARIOS = 'puntosUsuariosLealtad';
        const CLAVE_USUARIO_ACTIVO = 'usuarioActivo'; 
        const CLAVE_CANJES_PREMIOS = 'canjesPremios'; 
        // CLAVES PARA EL HISTORIAL Y CONTADORES
        const CLAVE_LOG_SCANS = 'logScans'; 
        const CLAVE_LOG_REDEEMS = 'logRedeems'; 
        const CLAVE_HISTORIAL = 'movimientoHistory';

        const RESTRICCION_CANJE_MS = 24 * 60 * 60 * 1000; 
        
        // ** PUNTOS Y C칍DIGOS DE CANJE **
        // Se a침ade un objeto para rastrear si un c칩digo ya fue usado por CUALQUIER USUARIO (para c칩digos secretos de un solo uso).
        const CLAVE_CODIGOS_USADOS = 'codigosUsados'; 
        
        const CODIGOS_DE_CANJE = {
            // C칩digos de Escaneo QR (se supone que son reutilizables con restricci칩n de tiempo/sesi칩n)
            "10019950": 50,
            "100199100": 100,
            "100199200": 200,
            "10019900": 10000,
            
            // ** C칩digos Secretos de UN SOLO USO (ejemplo) **
            "SECRETO100": 100,
            "PREMIUM500": 500,
            "SUPER1000": 1000
        };
        
        // ** USUARIOS DE PRUEBA **
        const USUARIOS_VALIDOS = {
            "juanzamora": { psw: "prueba", email: "mrandroidtutorialeshd@gmail.com" },
            "prueba1": { psw: "prueba1", email: "escuela100198@gmail.com" },
            "tprueba2": { psw: "prueba2", email: "juanzamora2025a@gmail.com" }
        };
        const WHATSAPP_NUMBER = "5217719624236"; 
        
        // --- CAT츼LOGO DE PREMIOS POR CATEGOR칈A (Omitido para concisi칩n, no se modific칩) ---
        const categoriasPremios = {
            "Aceites": [
                { id: 1, nombre: "Aditivo de Combustible", costo: 165, descripcion: "Potencia tu motor, maximiza tu rendimiento. Nuestro aditivo de gasolina elimina impurezas, reduce el consumo y prolonga la vida 칰til de tu motor. 춰Protege tu inversi칩n, optimiza tu viaje!.", imagen: "https://i.postimg.cc/mDHF11wQ/tom7sc2i4a2gzq0hljda.jpg" },
                { id: 5, nombre: "Anticongelante 33%", costo: 180, descripcion: "Protege tu motor del fr칤o y la corrosi칩n. Nuestro anticongelante de alta calidad garantiza un rendimiento 칩ptimo y prolonga la vida 칰til de tu veh칤culo.", imagen: "https://i.postimg.cc/JhWwC9F0/162832-d.jpg" },
                { id: 5, nombre: "L칤quido de Frenos", costo: 175, descripcion: "Frena con confianza. L칤quido de frenos de alta performance, garantiza una frenada segura y eficiente en cualquier condici칩n.", imagen: "https://i.postimg.cc/gJYfn3dv/images-6.jpg" },
                { id: 5, nombre: "Limpia Parabrisas", costo: 160, descripcion: "Visi칩n clara, conducci칩n segura. Nuestro l칤quido limpia parabrisas elimina la suciedad y el agua para una visibilidad perfecta en cualquier clima.", imagen: "https://i.postimg.cc/tRvL41c2/149425-d.jpg" },
                { id: 5, nombre: "Direcci칩n Hidr치ulica", costo: 150, descripcion: "Dirige con suavidad y precisi칩n. Nuestro l칤quido de direcci칩n hidr치ulica lubrica y protege el sistema, garantizando una conducci칩n suave y segura.", imagen: "https://i.postimg.cc/Y00ZxkvP/177506-d.jpg" }
            ],
            "Gasolina": [
                { id: 6, nombre: "Vale de $50 MXN", costo: 250, descripcion: "Aplicable en cualquier compra 칰nicamente en gasolineras participantes.", imagen: "https://i.postimg.cc/CL9FQrHQ/1761284472934.png" },
                { id: 7, nombre: "Vale de $100", costo: 450, descripcion: "Aplicable en cualquier compra 칰nicamente en gasolineras participantes.", imagen: "https://i.postimg.cc/ZKWbjz3Y/1761284392265.png" },
                { id: 7, nombre: "Vale de $200", costo: 800, descripcion: "Aplicable en cualquier compra 칰nicamente en gasolineras participantes.", imagen: "https://i.postimg.cc/bvhqzG5n/1761284478157.png" },
                { id: 7, nombre: "Vale de $500", costo: 1750, descripcion: "Aplicable en cualquier compra 칰nicamente en gasolineras participantes.", imagen: "https://i.postimg.cc/3Rr7vs7f/1761284484288.png" },
                { id: 7, nombre: "Vale de $1,000", costo: 4000, descripcion: "Aplicable en cualquier compra 칰nicamente en gasolineras participantes.", imagen: "https://i.postimg.cc/Y9X7fdCz/1761284573266.png" }
            ],
            "Revolution Wax": [
                { id: 8, nombre: "F칩rmula Premium", costo: 300, descripcion: "1 Envase con 1Litro de cera Revolution Wax aroma Frutal 5 en 1 para lavar en seco con cera de carnauba y para un brillo instant치neo.", imagen: "https://i.postimg.cc/9MqPGQV3/D-NQ-NP-827300-MLM92390346690-092025-O-2-revolution-wax-formula-premium-para-lavar-auto-en-seco-1l.webp" },
                { id: 8, nombre: "F칩rmula Premium", costo: 300, descripcion: "1 Envase con 1Litro de cera Revolution Wax aroma Fresas 5 en 1 para lavar en seco con cera de carnauba y para un brillo instant치neo.", imagen: "https://i.postimg.cc/Y2Yf00bg/D-NQ-NP-834678-MLM92797513859-092025-O-2-revolution-wax-aroma-fresa-formula-lavado-en-seco-1-litro.webp" },
                { id: 8, nombre: "F칩rmula Premium", costo: 550, descripcion: "2 Envase con 1Litro c/u de cera Revolution Wax aroma Frutal 5 en 1 para lavar en seco con cera de carnauba y para un brillo instant치neo.", imagen: "https://i.postimg.cc/9MqPGQV3/D-NQ-NP-827300-MLM92390346690-092025-O-2-revolution-wax-formula-premium-para-lavar-auto-en-seco-1l.webp" }
            ],            
            "Streaming": [
                { id: 10, nombre: "YouTube 1 mes", costo: 270, descripcion: "Una suscripci칩n de 30 d칤as a un servicio de streaming de video.", imagen: "https://i.postimg.cc/zB0GJwWL/1760066881281.png" }
            ],
            "Lavado y Encerado": [
                { id: 11, nombre: "Lavado Exterior + Cera", costo: 120, descripcion: "Servicio de lavado completo con aplicaci칩n de cera de carnauba.", imagen: "https://i.postimg.cc/Wz4Zw1T4/1761305072860.png" }
            ],
            "Sorpresa": [
                { id: 4, nombre: "Producto Sorpresa VIP", costo: 4000, descripcion: "Un regalo exclusivo por ser un cliente fiel.", imagen: "https://i.postimg.cc/YS5kxn7r/1761305366994.png" }
            ]
        };

        const catalogoPremios = Object.values(categoriasPremios).flat();


        let usuarioLogueado = null; 
        let usuarioLogueadoUsername = null; 
        let puntosUsuario = 0;
        let usuarioEscaneado = null; 
        let canjeTimerIntervals = {}; 

        // --- FUNCIONES DE SCROLL Y NAVEGACI칍N (Se mantienen) ---

        function scrollFunction() {
            const btn = document.getElementById("scrollToTopBtn");
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        }

        function topFunction() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function scrollToContact() {
             window.scrollTo({
                top: document.getElementById('contacto-redes').offsetTop - 50,
                behavior: 'smooth'
            });
        }

        function toggleDropdown(button) {
            const dropdown = document.getElementById('premios-dropdown');
            dropdown.classList.toggle('show');
        }

        function scrollToCategory(categoryName) {
            document.getElementById('premios-dropdown').classList.remove('show');
            const categoryId = `cat-${categoryName.replace(/\s/g, '-')}`;
            const targetElement = document.getElementById(categoryId);
            if (targetElement) {
                const offset = document.getElementById('nav-bar').offsetHeight + 20; 
                window.scrollTo({ 
                    top: targetElement.offsetTop - offset, 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        function renderDropdownCategories() {
            const dropdown = document.getElementById('premios-dropdown');
            dropdown.innerHTML = '';
            for (const categoria in categoriasPremios) {
                const categoryLink = document.createElement('a');
                categoryLink.textContent = categoria;
                categoryLink.onclick = () => scrollToCategory(categoria);
                dropdown.appendChild(categoryLink);
            }
        }
        
        // --- MANEJO DE PUNTOS, CANJES Y HISTORIAL (Modificado: a침adido load/save de c칩digos usados) ---
        
        // FUNCIONES DE ESTAD칈STICAS
        function loadStats(key) {
             try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        }

        function saveStat(key, userEmail, value) {
            const allStats = loadStats(key);
            allStats[userEmail] = value;
            localStorage.setItem(key, JSON.stringify(allStats));
        }

        function getStatValue(key, userEmail) {
            const allStats = loadStats(key);
            return allStats[userEmail] || 0;
        }

        function incrementStat(key, userEmail) {
            const currentValue = getStatValue(key, userEmail);
            saveStat(key, userEmail, currentValue + 1);
            return currentValue + 1;
        }

        // FUNCIONES DE C칍DIGOS DE UN SOLO USO
        function cargarCodigosUsados() {
            try {
                const data = localStorage.getItem(CLAVE_CODIGOS_USADOS);
                return data ? new Set(JSON.parse(data)) : new Set();
            } catch (e) {
                return new Set();
            }
        }
        
        function marcarCodigoComoUsado(codigo) {
            const codigosUsados = cargarCodigosUsados();
            codigosUsados.add(codigo);
            localStorage.setItem(CLAVE_CODIGOS_USADOS, JSON.stringify(Array.from(codigosUsados)));
        }
        
        function esCodigoDeUnSoloUso(codigo) {
            // Un c칩digo de un solo uso es aquel que existe en CODIGOS_DE_CANJE pero NO en la lista de C칩digos de Escaneo QR
            // Por simplicidad, consideraremos que todos los c칩digos que NO empiezan por "100199" son de un solo uso.
            return codigo in CODIGOS_DE_CANJE && !codigo.startsWith("100199");
        }


        // FUNCIONES DE HISTORIAL
        function loadHistory(userEmail) {
            try {
                const allHistory = localStorage.getItem(CLAVE_HISTORIAL);
                const historyObj = allHistory ? JSON.parse(allHistory) : {};
                return historyObj[userEmail] || [];
            } catch (e) {
                return [];
            }
        }

        function saveHistory(userEmail, historyArray) {
            let allHistory = {};
            try {
                const storedHistory = localStorage.getItem(CLAVE_HISTORIAL);
                allHistory = storedHistory ? JSON.parse(storedHistory) : {};
            } catch (e) {
                allHistory = {};
            }
            
            allHistory[userEmail] = historyArray;
            localStorage.setItem(CLAVE_HISTORIAL, JSON.stringify(allHistory));
        }

        function addMovementToHistory(userEmail, type, description) {
            const history = loadHistory(userEmail);
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
            const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            const newMovement = {
                type: type, // 'scan' (QR) o 'redeem' (Premio) o 'secret' (Bot칩n Acomular)
                timestamp: now.getTime(),
                date: `${dateStr} ${timeStr}`,
                description: description
            };

            history.unshift(newMovement); // A침adir al principio
            saveHistory(userEmail, history.slice(0, 50)); // Limitar a 50 movimientos
        }
        
        function renderizarEstadisticas() {
             if (!usuarioLogueado) return;

             // El contador CLAVE_LOG_SCANS se usar치 para ambos tipos de acumulaci칩n (QR y Bot칩n)
             const totalScans = getStatValue(CLAVE_LOG_SCANS, usuarioLogueado);
             const totalRedeems = getStatValue(CLAVE_LOG_REDEEMS, usuarioLogueado);

             document.getElementById('total-scans').textContent = totalScans;
             document.getElementById('total-redeems').textContent = totalRedeems;
        }
        
        function openHistoryModal(type) {
            if (!usuarioLogueado) return;

            const history = loadHistory(usuarioLogueado);
            const listElement = document.getElementById('history-list-popup');
            const titleElement = document.getElementById('history-modal-title');
            listElement.innerHTML = '';

            const filteredHistory = history.filter(item => item.type === type || (type === 'scan' && item.type === 'secret'));

            if (type === 'scan') {
                titleElement.textContent = 'Historial de Puntos Acomulados (QR y Secreto)';
            } else if (type === 'redeem') {
                titleElement.textContent = 'Historial de Regalos Canjeados';
            }

            if (filteredHistory.length === 0) {
                listElement.innerHTML = `<li>No hay historial de ${type === 'scan' ? 'acomulaci칩n de puntos' : 'canjes'}.</li>`;
            } else {
                filteredHistory.forEach(item => {
                    const li = document.createElement('li');
                    
                    let icon = item.type === 'redeem' ? '游꾸' : '拘勇';
                    li.className = item.type === 'redeem' ? 'redeem-item' : 'scan-item';
                    
                    li.innerHTML = `<strong>${icon} ${item.description}</strong><br><span style="font-size: 0.9em; color: #6c757d;">${item.date}</span>`;
                    listElement.appendChild(li);
                });
            }

            document.getElementById('history-modal').style.display = 'block';
        }


        // FUNCIONES DE PUNTOS Y CANJES
        function cargarPuntosUsuarios() {
            try {
                const data = localStorage.getItem(CLAVE_ALMACENAMIENTO_USUARIOS);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        }
        function guardarPuntosUsuario(email, puntos) {
            const todosLosPuntos = cargarPuntosUsuarios();
            todosLosPuntos[email] = puntos;
            localStorage.setItem(CLAVE_ALMACENAMIENTO_USUARIOS, JSON.stringify(todosLosPuntos));
        }

        function cargarCanjes() {
            try {
                const data = localStorage.getItem(CLAVE_CANJES_PREMIOS);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        }
        function guardarCanje(email, idPremio, timestamp) {
            const todosLosCanjes = cargarCanjes();
            if (!todosLosCanjes[email]) {
                todosLosCanjes[email] = {};
            }
            todosLosCanjes[email][idPremio] = timestamp;
            localStorage.setItem(CLAVE_CANJES_PREMIOS, JSON.stringify(todosLosCanjes));
        }

        // --- L칍GICA DE CRON칍METRO (Se mantiene) ---

        function formatTime(ms) {
            if (ms <= 0) return "춰Listo!";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function updateTimerDisplay(idPremio) {
            const canjes = cargarCanjes();
            const lastTimestamp = canjes[usuarioLogueado]?.[idPremio] || 0;
            const now = Date.now();
            const timeElapsed = now - lastTimestamp;
            const timeLeft = RESTRICCION_CANJE_MS - timeElapsed;

            const buttonElement = document.getElementById(`btn-canjear-${idPremio}`);

            if (!buttonElement) {
                clearInterval(canjeTimerIntervals[idPremio]);
                delete canjeTimerIntervals[idPremio];
                return;
            }

            if (timeLeft <= 0) {
                buttonElement.disabled = false;
                buttonElement.textContent = "Canjear";
                buttonElement.style.backgroundColor = 'var(--color-secundario)';
                clearInterval(canjeTimerIntervals[idPremio]);
                delete canjeTimerIntervals[idPremio];
            } else {
                buttonElement.disabled = true;
                buttonElement.textContent = formatTime(timeLeft); 
            }
        }

        function startTimer(idPremio) {
            if (canjeTimerIntervals[idPremio]) {
                clearInterval(canjeTimerIntervals[idPremio]);
            }
            canjeTimerIntervals[idPremio] = setInterval(() => {
                updateTimerDisplay(idPremio);
            }, 1000);
            updateTimerDisplay(idPremio);
        }
        
        function stopAllTimers() {
            Object.values(canjeTimerIntervals).forEach(clearInterval);
            canjeTimerIntervals = {};
        }


        // --- L칍GICA DE AUTENTICACI칍N (Se mantiene) ---

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.toLowerCase();
            const psw = document.getElementById('psw').value;
            const errorElement = document.getElementById('login-error');

            if (USUARIOS_VALIDOS[username] && USUARIOS_VALIDOS[username].psw === psw) {
                const email = USUARIOS_VALIDOS[username].email;
                localStorage.setItem(CLAVE_USUARIO_ACTIVO, email);
                iniciarSesion(username, email);
            } else {
                errorElement.textContent = "Usuario o contrase침a incorrectos.";
            }
        });

        function iniciarSesion(username, email) {
            usuarioLogueado = email;
            usuarioLogueadoUsername = username;
            document.getElementById('user-display').textContent = username;
            const todosLosPuntos = cargarPuntosUsuarios();
            puntosUsuario = todosLosPuntos[email] || 0;

            document.getElementById('login-section').style.display = 'none';
            document.getElementById('lealtad-section').style.display = 'block';
            
            document.getElementById('login-nav-bar').style.display = 'none'; 
            document.getElementById('nav-bar').style.display = 'flex'; 

            renderDropdownCategories();
            actualizarInterfaz();
            simularEscaneoQR();
            renderizarEstadisticas(); 
            
            document.getElementById('welcome-modal').style.display = 'block';
        }

        function logout() {
            localStorage.removeItem(CLAVE_USUARIO_ACTIVO);
            stopAllTimers();
            usuarioLogueado = null;
            usuarioLogueadoUsername = null;
            puntosUsuario = 0;
            
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('lealtad-section').style.display = 'none';
            
            document.getElementById('login-nav-bar').style.display = 'block'; 
            document.getElementById('nav-bar').style.display = 'none'; 
            
            document.getElementById('login-error').textContent = '';
            document.getElementById('login-form').reset();
            document.getElementById('username').value = '';
            document.getElementById('psw').value = '';
            
            document.getElementById("qr-code").innerHTML = '';
        }

        // --- L칍GICA DE CANJE Y REND. (Se mantiene) ---

        function canjearPremio(idPremio) {
            if (!usuarioLogueado) return alert("Debes iniciar sesi칩n para canjear premios.");
            const premio = catalogoPremios.find(p => p.id === idPremio);
            if (!premio) return;
            
            const canjes = cargarCanjes();
            const lastTimestamp = canjes[usuarioLogueado]?.[idPremio] || 0;
            const now = Date.now();
            const isRestricted = (now - lastTimestamp) < RESTRICCION_CANJE_MS;

            if (isRestricted) {
                return alert("丘멆잺 Este premio ya fue canjeado. Debes esperar 24 horas para volver a canjearlo.");
            }

            if (puntosUsuario >= premio.costo) {
                if (confirm(`쮺anjear "${premio.nombre}" por ${premio.costo} puntos?`)) {
                    puntosUsuario -= premio.costo;
                    
                    guardarCanje(usuarioLogueado, idPremio, Date.now());
                    
                    // INCREMENTAR CONTADOR Y REGISTRAR EN HISTORIAL
                    incrementStat(CLAVE_LOG_REDEEMS, usuarioLogueado);
                    addMovementToHistory(usuarioLogueado, 'redeem', `Canjeado: ${premio.nombre} (-${premio.costo} Pts)`);
                    
                    alert(`九 춰Canje exitoso! Obtenido: ${premio.nombre}. Puntos restantes: ${puntosUsuario}.`);
                    actualizarInterfaz();
                    renderizarEstadisticas();
                }
            } else {
                alert(`丘멆잺 춰Puntos insuficientes! Necesitas ${premio.costo} puntos y solo tienes ${puntosUsuario}.`);
            }
        }
        
        function renderizarCatalogo() {
            const contenedorCatalogo = document.getElementById('catalogo-premios');
            contenedorCatalogo.innerHTML = '';
            stopAllTimers();
            
            if (!usuarioLogueado) return; 
            
            const canjes = cargarCanjes();
            const now = Date.now();

            for (const categoria in categoriasPremios) {
                const premiosDeCategoria = categoriasPremios[categoria];
                const categoryId = `cat-${categoria.replace(/\s/g, '-')}`;

                const tituloCat = document.createElement('h2');
                tituloCat.className = 'categoria-titulo';
                tituloCat.id = categoryId;
                tituloCat.textContent = categoria;
                contenedorCatalogo.appendChild(tituloCat);

                const catalogoCat = document.createElement('div');
                catalogoCat.className = 'catalogo-categoria';

                premiosDeCategoria.forEach(premio => {
                    const puedeCanjearPorPuntos = puntosUsuario >= premio.costo;
                    
                    const lastTimestamp = canjes[usuarioLogueado]?.[premio.id] || 0;
                    const timeElapsed = now - lastTimestamp;
                    const isRestricted = timeElapsed < RESTRICCION_CANJE_MS;

                    const puedeCanjear = puedeCanjearPorPuntos && !isRestricted;
                    
                    let buttonText = 'Canjear';
                    let buttonStyle = '';

                    if (!puedeCanjearPorPuntos) {
                        buttonText = `Faltan ${premio.costo - puntosUsuario} Pts`;
                        buttonStyle = 'background-color: #9e9e9e !important;'; 
                    } else if (isRestricted) {
                        const timeLeft = RESTRICCION_CANJE_MS - timeElapsed;
                        buttonText = formatTime(timeLeft);
                        buttonStyle = 'background-color: var(--color-principal);';
                    }


                    const divPremio = document.createElement('div');
                    divPremio.className = 'premio';
                    
                    divPremio.innerHTML = `
                        <img src="${premio.imagen}" alt="${premio.nombre}" loading="lazy">
                        <h3>${premio.nombre}</h3>
                        <p>${premio.descripcion}</p>
                        <span class="puntos-costo">Costo: ${premio.costo} Puntos</span>
                        <p class="cronometro-texto"></p> 
                        <button 
                            onclick="canjearPremio(${premio.id})" 
                            class="btn-canjear" 
                            id="btn-canjear-${premio.id}"
                            ${!puedeCanjear ? 'disabled' : ''}
                            style="${buttonStyle}"
                        >
                            ${buttonText}
                        </button>
                    `;
                    catalogoCat.appendChild(divPremio);

                    if (isRestricted) {
                        startTimer(premio.id);
                    }
                });
                contenedorCatalogo.appendChild(catalogoCat);
            }
        }
        
        // --- L칍GICA DE BOT칍N "ACOMULAR" (NUEVO) ---

        function openAcumularModal() {
            if (!usuarioLogueado) {
                 alert("Por favor, inicia sesi칩n para acumular puntos.");
                 return;
            }
            document.getElementById('acumular-modal-message').textContent = '';
            document.getElementById('secret-code').value = '';
            document.getElementById('acumular-modal').style.display = 'block';
        }

        function procesarCodigoSecreto() {
            const codigoIngresado = document.getElementById('secret-code').value.trim().toUpperCase();
            const modalMessage = document.getElementById('acumular-modal-message');

            const puntosASumar = CODIGOS_DE_CANJE[codigoIngresado];
            
            if (!puntosASumar) {
                modalMessage.textContent = '仇 C칩digo incorrecto o inv치lido.';
                document.getElementById('secret-code').value = '';
                return;
            }
            
            const isSingleUse = esCodigoDeUnSoloUso(codigoIngresado);
            const codigosUsados = cargarCodigosUsados();
            
            if (isSingleUse && codigosUsados.has(codigoIngresado)) {
                modalMessage.textContent = '丘멆잺 Este c칩digo ya ha sido utilizado.';
                document.getElementById('secret-code').value = '';
                return;
            }
            
            // Si es un c칩digo de QR (100199...), no hacemos chequeo de uso global, solo el de sesi칩n (que se hace en procesarCanjeQR)
            if (!isSingleUse) {
                // Para c칩digos QR que se puedan introducir manualmente, usamos la misma l칩gica de sesi칩n/puntos que el escaneo
                // y usamos 'usuarioLogueado' como el usuario a acreditar, en lugar de 'usuarioEscaneado'.
                
                const sessionKey = `puntosSumados_${usuarioLogueado}`;
                if (sessionStorage.getItem(sessionKey)) {
                    modalMessage.textContent = '丘멆잺 춰Ya canjeaste los puntos en esta sesi칩n!';
                    return;
                }
                
                // Realizar la acreditaci칩n
                const todosLosPuntos = cargarPuntosUsuarios();
                puntosUsuario = todosLosPuntos[usuarioLogueado] || 0; 
                puntosUsuario += puntosASumar;
                
                guardarPuntosUsuario(usuarioLogueado, puntosUsuario); 
                sessionStorage.setItem(sessionKey, 'true'); // Marca como usado para la sesi칩n
                
                incrementStat(CLAVE_LOG_SCANS, usuarioLogueado);
                addMovementToHistory(usuarioLogueado, 'scan', `C칩digo Manual QR (+${puntosASumar} Pts)`);
                
            } else if (isSingleUse) {
                 // L칩gica de UN SOLO USO
                const todosLosPuntos = cargarPuntosUsuarios();
                puntosUsuario = todosLosPuntos[usuarioLogueado] || 0; 
                puntosUsuario += puntosASumar;
                
                guardarPuntosUsuario(usuarioLogueado, puntosUsuario); 
                marcarCodigoComoUsado(codigoIngresado); // Marcar como usado globalmente
                
                incrementStat(CLAVE_LOG_SCANS, usuarioLogueado);
                addMovementToHistory(usuarioLogueado, 'secret', `C칩digo Secreto ${codigoIngresado} (+${puntosASumar} Pts)`);
            }
            
            // Finalizar proceso
            document.getElementById('acumular-modal').style.display = 'none';
            actualizarInterfaz();
            alert(`游꿀 춰C칩digo correcto! ${puntosASumar} puntos sumados a tu cuenta.`);
        }
        
        // --- OTRAS L칍GICAS (procesarCanjeQR modificado para diferenciar c칩digos de un solo uso) ---

        function actualizarInterfaz() {
            document.getElementById('puntos-actuales').textContent = `${puntosUsuario} Puntos`;
            guardarPuntosUsuario(usuarioLogueado, puntosUsuario); 
            renderizarCatalogo(); 
            renderizarEstadisticas();
        }

        function simularEscaneoQR() {
            const currentUsername = usuarioLogueadoUsername;
            const URL_BASE = window.location.origin + window.location.pathname;
            const QR_DATA = `${URL_BASE}?action=addpoints&user=${currentUsername}`;
            
            document.getElementById("qr-code").innerHTML = '';
            
            new QRCode(document.getElementById("qr-code"), {
                text: QR_DATA,
                width: 150,
                height: 150,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }
        
        function mostrarModalCanje(userEmail) {
            // El modal de canje QR siempre acreditar치 al usuario 'escaneado'
            usuarioEscaneado = userEmail; 
            document.getElementById('modal-message').textContent = '';
            document.getElementById('redemption-code').value = '';
            document.getElementById('redemption-modal').style.display = 'block';
        }

        function procesarCanjeQR() {
            const codigoIngresado = document.getElementById('redemption-code').value.trim();
            const modalMessage = document.getElementById('modal-message');

            const sessionKey = `puntosSumados_${usuarioEscaneado}`;
            if (sessionStorage.getItem(sessionKey)) {
                modalMessage.textContent = '丘멆잺 춰Ya canjeaste los puntos para este escaneo!';
                return;
            }

            const puntosASumar = CODIGOS_DE_CANJE[codigoIngresado];

            if (puntosASumar) {
                 // Chequeo de c칩digos de un solo uso para evitar que un QR d칠 un c칩digo secreto de mucho valor
                if (esCodigoDeUnSoloUso(codigoIngresado) && cargarCodigosUsados().has(codigoIngresado)) {
                     modalMessage.textContent = '仇 C칩digo de canje ya utilizado.';
                     document.getElementById('redemption-code').value = '';
                     return;
                }
                
                // Si es un c칩digo de un solo uso, lo marcamos globalmente
                if (esCodigoDeUnSoloUso(codigoIngresado)) {
                     marcarCodigoComoUsado(codigoIngresado);
                }

                // *** L칍GICA CLAVE: C칍DIGO CORRECTO ***
                const todosLosPuntos = cargarPuntosUsuarios();
                let puntosTemporales = todosLosPuntos[usuarioEscaneado] || 0;
                puntosTemporales += puntosASumar;
                
                guardarPuntosUsuario(usuarioEscaneado, puntosTemporales); 
                sessionStorage.setItem(sessionKey, 'true'); 
                
                // INCREMENTAR CONTADOR Y REGISTRAR EN HISTORIAL (SOLO SI EL C칍DIGO FUE CORRECTO)
                incrementStat(CLAVE_LOG_SCANS, usuarioEscaneado);
                addMovementToHistory(usuarioEscaneado, 'scan', `Escaneo QR y Canje de C칩digo (+${puntosASumar} Pts)`);
                
                document.getElementById('redemption-modal').style.display = 'none';

                if (usuarioLogueado === usuarioEscaneado) {
                     puntosUsuario = puntosTemporales;
                     actualizarInterfaz();
                     renderizarEstadisticas(); 
                     alert(`游꿀 춰C칩digo correcto! ${puntosASumar} puntos sumados a tu cuenta.`);
                } else {
                    alert(`九 ${puntosASumar} puntos sumados a la cuenta de ${usuarioEscaneado}. Por favor, inicia sesi칩n para ver tu saldo.`);
                }
            } else {
                // *** C칍DIGO INCORRECTO: NO SUMA PUNTOS NI CUENTA ESCANEO ***
                modalMessage.textContent = '仇 C칩digo de canje incorrecto o inv치lido. No se sumaron puntos.';
                document.getElementById('redemption-code').value = ''; 
            }
        }

        function verificarEscaneoAlCargar() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const userFromQR_Username = urlParams.get('user');

            if (action === 'addpoints' && userFromQR_Username) {
                 const userData = USUARIOS_VALIDOS[userFromQR_Username];
                 const userEmailToCredit = userData ? userData.email : null;

                if (userEmailToCredit) {
                    const URL_BASE = window.location.origin + window.location.pathname;
                    history.replaceState(null, '', URL_BASE);
                    mostrarModalCanje(userEmailToCredit);
                } else {
                    alert('Error: Usuario del QR no encontrado.');
                }
            }
        }

        function crearUsuarioWhatsapp() {
            const newEmail = document.getElementById('new-email').value.trim();
            const newUsername = document.getElementById('new-username').value.trim();
            const newPsw = document.getElementById('new-psw').value.trim();
            const createMessage = document.getElementById('create-message');

            if (!newEmail || !newUsername || !newPsw) {
                createMessage.style.color = 'red';
                createMessage.textContent = 'Por favor, completa todos los campos.';
                return;
            }
            if (USUARIOS_VALIDOS.hasOwnProperty(newUsername)) {
                createMessage.style.color = 'red';
                createMessage.textContent = 'El usuario ya existe. Intenta con otro.';
                return;
            }

            const mensaje = `춰SOLICITUD DE NUEVA CUENTA DE LEALTAD!%0A*Correo:* ${newEmail}%0A*Usuario:* ${newUsername}%0A*Contrase침a deseada:* ${newPsw}%0A%0APor favor, registrar y confirmar la cuenta.`;
            const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${mensaje}`;
            
            window.open(whatsappURL, '_blank');

            createMessage.style.color = 'green';
            createMessage.textContent = 'Solicitud enviada a WhatsApp. Nos comunicaremos contigo pronto.';
            document.getElementById('create-user-modal').style.display='none'; 
        }

        function recuperarContrasena() {
            const recoverEmail = document.getElementById('recover-email').value.trim();
            const recoverUsername = document.getElementById('recover-username').value.trim();
            const recoverMessage = document.getElementById('recover-message');

            recoverMessage.textContent = '';
            const userEntry = USUARIOS_VALIDOS[recoverUsername];

            if (userEntry && userEntry.email === recoverEmail) {
                recoverMessage.style.color = 'green';
                recoverMessage.innerHTML = `九 춰Encontrada! Tu contrase침a es: <strong>${userEntry.psw}</strong>`;
            } else {
                recoverMessage.style.color = 'red';
                recoverMessage.textContent = '仇 Error: El Usuario y el Correo no coinciden.';
            }
        }
        
        // --- INICIALIZACI칍N DE LA APLICACI칍N (Se mantiene) ---
        
        verificarEscaneoAlCargar();
        const usuarioEmailGuardado = localStorage.getItem(CLAVE_USUARIO_ACTIVO);
        
        const loginNavBar = document.getElementById('login-nav-bar');
        const navBar = document.getElementById('nav-bar');

        if (usuarioEmailGuardado) {
            loginNavBar.style.display = 'none';
            navBar.style.display = 'flex';
            
            const currentUserEntry = Object.entries(USUARIOS_VALIDOS).find(([username, data]) => data.email === usuarioEmailGuardado);
            if (currentUserEntry) {
                const username = currentUserEntry[0];
                iniciarSesion(username, usuarioEmailGuardado);
            } else {
                logout();
            }
        } else {
            loginNavBar.style.display = 'block';
            navBar.style.display = 'none';
        }
        
    </script>
</body>
</html>
